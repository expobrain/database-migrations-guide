
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../add/columns/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>How tos - Database Migrations Guide</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-can-the-access-exclusive-lock-break-applications" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Database Migrations Guide" class="md-header__button md-logo" aria-label="Database Migrations Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Database Migrations Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How tos
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/expobrain/database-migrations-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    expobrain/database-migrations-guide
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Postgres

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Database Migrations Guide" class="md-nav__button md-logo" aria-label="Database Migrations Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Database Migrations Guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/expobrain/database-migrations-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    expobrain/database-migrations-guide
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Postgres
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Postgres
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    How tos
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    How tos
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-can-the-access-exclusive-lock-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can the ACCESS EXCLUSIVE lock break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-can-the-lock-queue-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can the lock queue break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-can-applications-block-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can applications block migrations?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-applications-to-not-block-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Write applications to not block migrations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-obtain-a-lock-safely-for-a-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to obtain a lock safely for a migration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-can-the-for-update-lock-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can the FOR UPDATE lock break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-the-row-exclusive-lock-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        Can the ROW EXCLUSIVE lock break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-the-disadvantages-of-a-not-null-check-constraint" class="md-nav__link">
    <span class="md-ellipsis">
      
        What are the disadvantages of a NOT NULL check constraint
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-the-list-of-index-for-a-given-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get the list of index for a given table
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Add
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Add
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add/columns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Columns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add/constraints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Constraints
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add/foreign_keys/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Foreign keys
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add/indexes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Indexes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Alter
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Alter
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../alter/data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../alter/table/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Table
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Drop
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Drop
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../drop/data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../drop/tables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-can-the-access-exclusive-lock-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can the ACCESS EXCLUSIVE lock break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-can-the-lock-queue-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can the lock queue break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-can-applications-block-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can applications block migrations?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-applications-to-not-block-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Write applications to not block migrations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-obtain-a-lock-safely-for-a-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to obtain a lock safely for a migration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-can-the-for-update-lock-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        How can the FOR UPDATE lock break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-the-row-exclusive-lock-break-applications" class="md-nav__link">
    <span class="md-ellipsis">
      
        Can the ROW EXCLUSIVE lock break applications?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-the-disadvantages-of-a-not-null-check-constraint" class="md-nav__link">
    <span class="md-ellipsis">
      
        What are the disadvantages of a NOT NULL check constraint
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-the-list-of-index-for-a-given-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get the list of index for a given table
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>How tos</h1>

<h2 id="how-can-the-access-exclusive-lock-break-applications">How can the ACCESS EXCLUSIVE lock break applications?</h2>
<p>An <code>ACCESS EXCLUSIVE</code> lock conflicts with everything, including:</p>
<ul>
<li><code>SELECT</code></li>
<li><code>INSERT</code></li>
<li><code>UPDATE</code></li>
<li><code>DELETE</code></li>
</ul>
<p>If a transaction is used, all rows will be locked until the transaction is committed.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A migration needing this lock will block other queries as soon as the SQL is sent to Postgres (even while waiting for a lock). See <a href="#how-can-the-lock-queue-break-applications">How can the lock queue break applications</a>?</p>
</div>
<h2 id="how-can-the-lock-queue-break-applications">How can the lock queue break applications?</h2>
<p>A migration can block application queries even while it is waiting for its turn to execute.</p>
<ol>
<li>Migration SQL is sent to Postgres</li>
<li>It cannot execute right now because it needs to obtain a lock</li>
<li>The migration enters the lock queue</li>
<li>Now, the application executes another query that needs a lock that would conflict with the migration's lock.</li>
<li>The application query enters the lock queue <em>behind</em> the migration SQL.</li>
<li>The application query is blocked on the migration SQL which is blocked on some other application query.</li>
</ol>
<p>So even though the application query <em>could</em> execute because the migration is not executing, Postgres will not do this!</p>
<p>So even if the migration would execute instantly <em>if only it had the lock</em>, it doesn't matter. It starts to block other conflicting queries immediately.</p>
<p>This could mean the application has temporarily degraded performance, and worse, if the migration is taking too long, actual queries and requests will start to fail until the migration has completed.</p>
<p>Therefore, you <em>should</em> use a <code>statement_timeout</code> that is about a second long.</p>
<div class="highlight"><pre><span></span><code><span class="k">SET</span><span class="w"> </span><span class="n">statement_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that a <code>lock_timeout</code> is a subset of a <code>statement_timeout</code>, but queries are blocked while in the lock queue and while the migration is executing therefore a <code>statement_timeout</code> is the appropriate timeout to use.</p>
</div>
<p>Since this is likely to timeout for busy tables, an automatic retry script <em>should</em> be used. See <a href="#how-can-the-lock-queue-break-applications">How to obtain a lock safely for a migration</a>.</p>
<h2 id="how-can-applications-block-migrations">How can applications block migrations?</h2>
<p>Lock queue.</p>
<p>Migration can never obtain a lock because it uses a <code>lock_timeout</code> because it must never break applications.</p>
<p>When a query or migration requires a lock, it will enter the lock queue.</p>
<p>Any locks that conflict with a lock in the queue will have to wait for its turn.</p>
<p>This means application queries can be blocked by migrations.</p>
<p>It <strong>also</strong> means that migrations can be blocked by application queries.</p>
<p>Therefore, applications should keep queries and transactions short.</p>
<p>Try to break transactions into smaller chunks that are less than a minute long, and add a sleep time in between these chunks.</p>
<p>This will give a chance for a migration to obtain a lock before its <code>lock_timeout</code> expires.</p>
<p>Of course, it is likely that a migration will need to be retried using a bash script.</p>
<p>A migration <em>should</em> use a short <code>lock_timeout</code> and a slightly longer <code>statement_timeout</code> when it is retrying.</p>
<p>This is so that the application does not become degraded.</p>
<p>There are usually two parts to a server application: the client-facing application such as an API, and background services/jobs such as crons or message processors.</p>
<p>The client-facing part usually naturally has short queries and transactions. However, background tasks can have long-running transactions and queries that can block migrations.</p>
<h2 id="write-applications-to-not-block-migrations">Write applications to not block migrations</h2>
<p>he application needs to give migrations a chance to obtain a lock.</p>
<p>So structure application queries and transactions so that there is opportunity for other processes to obtain a lock.</p>
<p>Actions:</p>
<ol>
<li>All transactions should be as short as possible, ideally less than minute long.</li>
<li>Split up long-running transactions into smaller chunks. Consider using a separate staging table for the job.</li>
<li>In between these smaller transactions, sleep for a few seconds to give other processes a chance to get a lock on the table.</li>
<li>Even with this, for extremely busy tables, it will be necessary to be able to temporarily shut down background jobs leaving only the absolutely necessary parts of the application running.</li>
<li>Background tasks should be written to handle immediate termination, and there should be a mechanism to immediately or gracefully stop these tasks.</li>
</ol>
<h2 id="how-to-obtain-a-lock-safely-for-a-migration">How to obtain a lock safely for a migration</h2>
<p>Execute a migration that obtains a dangerous lock without blocking application queries.</p>
<p>So execute the migration using a script to automatically retry, and use a short <code>lock_timeout</code> with a sleep time to minimise the impact on the application.</p>
<p>The retry script:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>date
<span class="w">    </span>psql<span class="w"> </span>-qX<span class="w"> </span>-v<span class="w"> </span><span class="nv">ON_ERROR_STOP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>-f<span class="w"> </span>migration.sql<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;done&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">break</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="k">done</span>
</code></pre></div>
<p>Example <code>migration.sql</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="k">SET</span><span class="w"> </span><span class="n">lock_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="n">statement_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<p>Every one second queries will be blocked for 100 milliseconds, except when the migration has got its lock, then queries could be blocked for 1000 milliseconds.</p>
<h2 id="how-can-the-for-update-lock-break-applications">How can the FOR UPDATE lock break applications?</h2>
<p>From the perspective of an application, the row-level <code>FOR UPDATE</code> lock will block some writes to the table, e.g.:</p>
<ul>
<li><code>UPDATE</code></li>
<li><code>SELECT FOR UPDATE</code></li>
<li><code>DELETE</code></li>
</ul>
<p>This lock only blocks the selected rows, rather than the whole table. However, <code>UPDATE table SET column = value;</code> will effectively lock the entire table.</p>
<p>If a transaction is used, the rows will be locked until the transaction is committed.</p>
<p>Therefore it's important to reduce the number of rows blocked, and to reduce the amount of time those rows are blocked, in order to prevent the application from being blocked with its update operations.</p>
<h2 id="can-the-row-exclusive-lock-break-applications">Can the ROW EXCLUSIVE lock break applications?</h2>
<p>Technically, a table-level <code>ROW EXCLUSIVE</code> is obtained as well as this is an UPDATE. However, this doesn't conflict with the kind of queries that applications do including other <code>UPDATE</code> SQL.</p>
<p>On the other hand, it <em>can</em> conflict with other migrations, so make sure you only do one migration at a time and this includes data migrations.</p>
<h2 id="what-are-the-disadvantages-of-a-not-null-check-constraint">What are the disadvantages of a NOT NULL check constraint</h2>
<ul>
<li>People may not realise the column is<code>NOT NULL</code> because the constraint belongs to the table rather than being an option on the column.</li>
<li>Writes are slower (~0.5-1% hit)</li>
<li>Managing a constraint may be more complicated with your ORM and migration framework(s).</li>
</ul>
<h2 id="get-the-list-of-index-for-a-given-table">Get the list of index for a given table</h2>
<p>To get the list of all the indexes for a given table in PostgreSQL:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_indexes</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;my-table&#39;</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>